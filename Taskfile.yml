# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
# ============================================================================
# Generated by: xplat manifest bootstrap
# Regenerate with: xplat manifest bootstrap --force
# Source: https://github.com/joeblew999/xplat
# Template: internal/templates/project/taskfile.yml.tmpl
# ============================================================================
#
# plat-tinypio Taskfile - Run 'xplat task' to see available commands
#
# xplat file structure:
#   xplat.yaml              - Package manifest (defines binary, processes, env)
#   Taskfile.yml            - THIS FILE: all build/run/service tasks
#   taskfiles/Taskfile.service.yml - Generated reusable tasks for pkg consumers
#   process-compose.yaml    - Process orchestration (uses xplat task commands)

version: "3"

dotenv: ['.env']

vars:
  # xplat binary - all commands go through xplat for cross-platform support
  XPLAT: xplat

  # Binary configuration
  BINARY: tinypio
  MAIN: ./cmd/tinypio

env:
  GOWORK: off

tasks:
  default:
    desc: Show available tasks
    cmds:
      - '{{.XPLAT}} task --list'

  # ===========================================================================
  # Build - Local project
  # ===========================================================================

  build:
    desc: Build the binary
    cmds:
      - mkdir -p .bin
      - go build -o .bin/{{ .BINARY }} {{ .MAIN }}

  test:
    desc: Run tests
    cmds:
      - echo "No tests yet"

  lint:
    desc: Run linter
    cmds:
      - golangci-lint run || echo "golangci-lint not installed, skipping"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf .bin/

  install:
    desc: Install to GOBIN
    cmds:
      - go install {{ .MAIN }}

  run:
    desc: Build and run
    deps: [build]
    sources:
      - '{{ .MAIN }}/**/*.go'
      - go.mod
    cmds:
      - ./.bin/{{ .BINARY }}

  dev:
    desc: Build and run with hot reload (watches for file changes)
    cmds:
      - '{{.XPLAT}} task run --watch'

  mod:
    desc: Tidy modules
    cmds:
      - go mod tidy

  # ===========================================================================
  # Release Commands (called by CI on tags)
  # ===========================================================================

  release:build:
    desc: Build release binary for current platform
    cmds:
      - mkdir -p .releases
      - go build -ldflags="-s -w" -o .releases/{{ .BINARY }}-{{ OS }}-{{ ARCH }}{{ exeExt }} {{ .MAIN }}

  release:list:
    desc: List built release binaries
    cmds:
      - ls -la .releases/ 2>/dev/null || echo "No releases built yet"

  # ===========================================================================
  # pioasm - PIO Assembler from pico-sdk
  # ===========================================================================

  pioasm:check:
    desc: Check if pioasm is installed
    cmds:
      - |
        if command -v pioasm &> /dev/null; then
          echo "pioasm found: $(which pioasm)"
          pioasm --version 2>/dev/null || true
        else
          echo "pioasm not found. Run 'xplat task pioasm:install' to install."
          exit 1
        fi

  pioasm:install:
    desc: Install pioasm from pico-sdk
    cmds:
      - |
        set -e
        mkdir -p .src
        if [ ! -d ".src/pico-sdk" ]; then
          echo "Cloning pico-sdk..."
          git clone --depth 1 https://github.com/raspberrypi/pico-sdk.git .src/pico-sdk
        fi
        echo "Building pioasm..."
        cd .src/pico-sdk/tools/pioasm
        cmake -B build .
        cmake --build build
        echo ""
        echo "pioasm built at: $(pwd)/build/pioasm"
        echo ""
        echo "To install system-wide, run:"
        echo "  sudo cp $(pwd)/build/pioasm /usr/local/bin/"
        echo ""
        echo "Or add to PATH:"
        echo "  export PATH=\"$(pwd)/build:\$PATH\""

  pioasm:install-global:
    desc: Install pioasm to /usr/local/bin (requires sudo)
    deps: [pioasm:install]
    cmds:
      - sudo cp .src/pico-sdk/tools/pioasm/build/pioasm /usr/local/bin/
      - echo "pioasm installed to /usr/local/bin/pioasm"

  # ===========================================================================
  # GitHub Pages
  # ===========================================================================

  pages:enable:
    desc: Enable GitHub Pages for this repo (requires gh CLI)
    cmds:
      - |
        REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null)
        if [ -z "$REPO" ]; then
          echo "Error: Not in a GitHub repo or gh not authenticated"
          exit 1
        fi
        gh api repos/$REPO/pages --method POST -f build_type=workflow 2>/dev/null || \
        gh api repos/$REPO/pages --method PUT -f build_type=workflow 2>/dev/null || \
        echo "Pages already enabled or error occurred"
        echo "GitHub Pages: https://$(echo $REPO | cut -d/ -f1).github.io/$(echo $REPO | cut -d/ -f2)/"

